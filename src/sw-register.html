<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="sw-register">

  <template>
    <paper-toast fit-into="[[headerLayout]]" text="[[toastMessage]]" id="toast"></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'sw-register',

      ready: function ready() {
        var self = this;

        this.headerLayout = Bridge.headerLayout;

        // SW logic are copied from Google IO webapp 2016
        // Source: https://github.com/GoogleChrome/ioweb2016/blob/master/app/scripts/helper/service-worker-registration.js
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js').then(function (res) {

            res.onupdatefound = function () {
              var installing = res.installing;
              installing.onstatechange = function () {

                if (installing.state === 'installed' && !navigator.serviceWorker.controller) {
                  self.toastMessage = "Installation complete. I can now work offline. (Trust me, it's real)";
                  self.$.toast.show();
                }
              };
            };
          }).catch(function (err) {
            console.error('Error when registering service worker. Error: ', err);
          });

          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.onstatechange = function (event) {
              if (event.target.state === 'redundant') {

                self.toastMessage = 'Update available. Refresh to get latest content';
                self.$.toast.show();
              }
            };
          }
        }
      }
    });
  </script>
</dom-module>
