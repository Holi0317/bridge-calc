<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="lodash/isinteger.html">
<link rel="import" href="bridge-player-model.html">

<dom-module id="bridge-data">
  <template>
    <iron-localstorage name="Bridge.players"
                       value="{{players}}"
                       on-iron-localstorage-load-empty="_initPlayers"
                       iron-localstorage-load="_upgradePlayers"></iron-localstorage>
    <iron-localstorage name="Bridge.totalRounds" value="{{totalRounds}}" on-iron-localstorage-load-empty="_initTotalRounds"></iron-localstorage>
    <iron-localstorage name="Bridge.state" value="{{state}}" on-iron-localstorage-load-empty="_initState"></iron-localstorage>
    <iron-localstorage name="Bridge.maker" value="{{maker}}" on-iron-localstorage-load-empty="_initMaker"></iron-localstorage>
    <iron-localstorage name="Bridge.currentRound" value="{{currentRound}}" on-iron-localstorage-load-empty="_initCurrentRound"></iron-localstorage>
  </template>

  <script>
    Bridge.gameState = {
      notStarted: 0,  // No info is filled in. Game is not yet started.
      guess: 1,  // Guess for stack before each round
      inputActual: 2,  // Wait for user to input actual stack
      waiting: 3, // This round has ended. Showing this round result and wait for next round to start
      gameEnd: 4  // Game has end by reaching the last round and ended
    };

    Polymer({
      is: 'bridge-data',

      properties: {
        state: {
          type: Number,
          notify: true
        },
        totalRounds: {
          type: Number,
          notify: true
        },
        currentRound: {
          type: Number,
          notify: true
        },
        maker: {  // ID, a.k.a. Array position, of current maker
          type: Number,
          notify: true
        },
        players: {
          type: Array,
          notify: true
        }
      },

      start(numberOfCard, playerNames) {
        if (!lodash.isInteger(numberOfCard)) {
          return 'Poker card must be an integer larger than 0. How do you get 0.5 card?';
        }

        if (playerNames.length <= 1) {
          return 'A game cannot be started with no none';
        }

        if (playerNames.length > numberOfCard) {
          return 'Too many players detected. Or you got too few card.';
        }

        this.totalRounds = Math.floor(numberOfCard / playerNames.length);
        this.currentRound = 1;
        this.maker = 0;
        this.players = playerNames.map(name => new Bridge.Player(name));
        this.state = Bridge.gameState.guess;

        return null;

      },

      _upgradePlayers() {
        console.log('Upgrading player from localstorage');
        this.players = this.players.map(el => new Bridge.Player(el));
      },

      _initPlayers() {
        this.players = [new Bridge.Player(), new Bridge.Player(), new Bridge.Player(), new Bridge.Player()];
      },

      _initTotalRounds() {
        this.totalRounds = null;
      },

      _initState() {
        this.state = Bridge.gameState.notStarted;
      },

      _initMaker() {
        this.maker = null;
      },

      _initCurrentRound() {
        this.currentRound = null
      }
    });
  </script>
</dom-module>
