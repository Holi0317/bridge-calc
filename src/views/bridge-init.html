<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bridge-input-player.html">
<link rel="import" href="../bridge-player-name.html">
<link rel="import" href="../bridge-redirect.html">
<link rel="import" href="../game-service.html">

<dom-module id="bridge-init">
  <style>
    :host {
      display: block;
      padding: 0 10px;
    }

    paper-material {
      background: white;
      box-sizing: border-box;
      margin: 8px;
      padding: 16px;
      border-radius: 2px;
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
    }

    #start {
      background: var(--paper-green-500);
      color: white;
    }

    #redirect {
      display: none;
    }

    paper-button [dialog-dismiss] {
      color: var(--paper-red-500);
    }

    paper-button [dialog-confirm] {
      color: var(--paper-green-500);
    }

  </style>

  <template>

    <div class="container">
      <h1>New Game</h1>
    </div>

    <div class="container">
      <paper-material>
        <bridge-input-player value="{{playerNames}}"></bridge-input-player>
      </paper-material>
    </div>

    <div class="container">
      <paper-material>
        <paper-input label="Number of cards" value="{{numberOfCard}}" type="number"></paper-input>
      </paper-material>
    </div>

    <div class="container">
      <paper-material>
        <h3>Game Informations</h3>
        <p>Number of players: [[playerNames.length]]</p>
        <p>Rounds: [[_countRound(playerNames.length, numberOfCard)]]</p>
        <paper-button raised id="start">Start</paper-button>
      </paper-material>
    </div>

    <paper-toast fit-into=[[headerLayout]] id="toast" text="[[toastMessage]]"></paper-toast>

    <bridge-redirect id="redirect"></bridge-redirect>

    <paper-dialog id="modal" modal
                  fit-into=[[headerLayout]]
                  entry-animation="scale-up-animation"
                  exit-animation="fade-out-animation"
                  on-iron-overlay-closed="_modalClosed"
                  on-iron-overlay-opened="_hackOverlay">
      <p>Existing game found. You really want to start a new game?</p>

      <div class="buttons">
        <paper-button dialog-dismiss autofocus>No</paper-button>
        <paper-button dialog-confirm>Yes</paper-button>
      </div>

    </paper-dialog>

  </template>

  <script>
    Polymer({
      is: 'bridge-init',
      properties: {
        playerNames: {
          type: Array
        },
        numberOfCard: {
          type: Number,
          value: 52
        },
        toastMessage: {
          type: String,
          value: null
        },
        service: {
          type: Object,
          notify: true
        }
      },

      listeners: {
        'start.click': '_start'
      },

      ready: function ready() {
        this.headerLayout = Bridge.headerLayout;
      },

      _countRound: function _countRound() {
        return Math.floor(this.numberOfCard / this.playerNames.length);
      },

      _start: function _start() {
        if (Bridge.Game.state !== Bridge.gameState.notStarted || Bridge.Game.state !== Bridge.gameState.gameEnd) {
          this.$.modal.open();
          return;
        }
        var res = Bridge.Game.start(this.numberOfCard, this.playerNames);
        if (res) {
          this.toastMessage = res;
          this.$.toast.open();
          return;
        } else {
          Bridge.Game.notify(this);
          this.$.redirect.redirect('game');
        }
      },

      _modalClosed: function _modalClosed(event) {
        if (event.detail.confirmed) {
          Bridge.Game.state = Bridge.gameState.notStarted;
          this._start();
        }
      },

      _hackOverlay: function _hackOverlay(e) {
        if (e.target.withBackdrop) {
          e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
        }
      },

    });
  </script>
</dom-module>
